<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projeto 50K</title>

<style>
body {
  margin: 0;
  padding-top: 220px;
  font-family: Arial, sans-serif;
  background: #f5f5f5;
}

/* TOPO FIXO */
.topo {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #222;
  color: #fff;
  padding: 10px;
  z-index: 1000;
}

/* T√çTULO */
.titulo {
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 8px;
}

/* INFO */
.topo-conteudo {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  font-size: 14px;
}

.box {
  background: #333;
  padding: 6px;
  border-radius: 6px;
  text-align: center;
}

.marcado {
  background: #4caf50;
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
}

/* PROGRESSO */
.progresso-container {
  margin-top: 10px;
}

.barra {
  width: 100%;
  height: 16px;
  background: #444;
  border-radius: 8px;
  overflow: hidden;
}

.barra-preenchida {
  height: 100%;
  width: 0%;
  background: #4caf50;
  transition: width 0.3s;
}

.percentual {
  text-align: center;
  font-size: 13px;
  margin-top: 4px;
}

/* BACKUP */
.backup-info {
  position: absolute;
  top: 10px;
  right: 10px;
  text-align: right;
  font-size: 12px;
  color: #ccc;
}

.backup-info button {
  margin-top: 4px;
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  background: #4caf50;
  color: #fff;
  cursor: pointer;
  font-size: 12px;
}

/* TABELA */
table {
  width: 100%;
  border-collapse: collapse;
}

td {
  border: 1px solid #ddd;
  padding: 10px 0;
  text-align: center;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
  background: #fff;
}

td.marcado {
  background: #4caf50;
  color: #fff;
  font-weight: bold;
}

/* DESKTOP */
@media (min-width: 768px) {
  body { padding-top: 180px; }
  .topo-conteudo { grid-template-columns: repeat(4, 1fr); }
  td { font-size: 16px; padding: 12px; }
}
</style>
</head>

<body>

<div class="topo">
  <div class="titulo">Projeto 50K</div>

  <div class="backup-info">
    √öltimo backup:<br>
    <span id="backupData">‚Äî</span><br>
    <button onclick="restaurarUltimoBackup()">Restaurar √∫ltimo backup</button>
  </div>

  <div class="topo-conteudo">
    <div class="box">Saldo<br><span id="saldo" class="marcado">R$ 0,00</span></div>
    <div class="box">Faltam<br><span id="faltam">R$ 0,00</span></div>
    <div class="box">Dep√≥sitos<br><strong id="qtdMarcados">0</strong></div>
    <div class="box">Restam<br><strong id="qtdRestam">0</strong></div>
  </div>

  <div class="progresso-container">
    <div class="barra">
      <div class="barra-preenchida" id="barra"></div>
    </div>
    <div class="percentual" id="percentual">0% conclu√≠do</div>
  </div>
</div>

<table id="tabela"></table>

<script type="module">
/* üî• FIREBASE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzIGJub68rmKIt1Qzsc9Aygbd1IeHF4kY",
  authDomain: "tabela-selecao.firebaseapp.com",
  projectId: "tabela-selecao",
  storageBucket: "tabela-selecao.firebasestorage.app",
  messagingSenderId: "182647940029",
  appId: "1:182647940029:web:393aec06b26187c01828d4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = doc(db, "estado", "selecionados");

/* üìä CONFIG */
const TOTAL = 316;
const SOMA_TOTAL = TOTAL * (TOTAL + 1) / 2;
const BACKUP_KEY = "projeto50k_backups";

/* ELEMENTOS */
const tabela = document.getElementById("tabela");
const saldoSpan = document.getElementById("saldo");
const faltamSpan = document.getElementById("faltam");
const qtdMarcadosSpan = document.getElementById("qtdMarcados");
const qtdRestamSpan = document.getElementById("qtdRestam");
const barra = document.getElementById("barra");
const percentualSpan = document.getElementById("percentual");
const backupDataSpan = document.getElementById("backupData");

let selecionados = new Set();

/* üáßüá∑ FORMATAR */
function formatarBR(valor) {
  return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

/* üíæ BACKUP AUTOM√ÅTICO */
function salvarBackupLocal() {
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "[]");
  backups.push({
    data: new Date().toISOString(),
    itens: [...selecionados]
  });
  localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
  backupDataSpan.textContent = new Date().toLocaleString("pt-BR");
}

/* ‚ôª RESTAURAR */
window.restaurarUltimoBackup = function () {
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "[]");
  if (!backups.length) return alert("Nenhum backup encontrado.");
  const ultimo = backups[backups.length - 1];
  selecionados = new Set(ultimo.itens);
  montarTabela();
  salvarFirebase();
};

/* üîÑ FIREBASE */
async function salvarFirebase() {
  await setDoc(ref, { itens: [...selecionados] });
}

async function carregar() {
  const snap = await getDoc(ref);
  if (snap.exists()) selecionados = new Set(snap.data().itens || []);
  restaurarUltimoBackupAutomatico();
  montarTabela();
}

/* üîÅ AUTO RESTORE */
function restaurarUltimoBackupAutomatico() {
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "[]");
  if (!backups.length) return;
  const ultimo = backups[backups.length - 1];
  selecionados = new Set(ultimo.itens);
  backupDataSpan.textContent = new Date(ultimo.data).toLocaleString("pt-BR");
}

/* üß± TABELA */
function montarTabela() {
  tabela.innerHTML = "";
  let linha;

  for (let i = 1; i <= TOTAL; i++) {
    if ((i - 1) % 10 === 0) linha = tabela.insertRow();
    const td = linha.insertCell();
    td.textContent = `R$ ${i}`;

    if (selecionados.has(i)) td.classList.add("marcado");

    td.onclick = () => {
      selecionados.has(i) ? selecionados.delete(i) : selecionados.add(i);
      td.classList.toggle("marcado");
      atualizar();
      salvarFirebase();
      salvarBackupLocal();
    };
  }
  atualizar();
}

/* üìà ATUALIZAR */
function atualizar() {
  const soma = [...selecionados].reduce((a, b) => a + b, 0);
  const qtd = selecionados.size;
  const perc = (qtd / TOTAL) * 100;

  saldoSpan.textContent = formatarBR(soma);
  faltamSpan.textContent = formatarBR(SOMA_TOTAL - soma);
  qtdMarcadosSpan.textContent = qtd;
  qtdRestamSpan.textContent = TOTAL - qtd;
  barra.style.width = perc + "%";
  percentualSpan.textContent = perc.toFixed(1) + "% conclu√≠do";
}

carregar();
</script>

</body>
</html>
