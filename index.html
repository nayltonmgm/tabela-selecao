<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projeto 50K</title>

<style>
body {
  margin: 0;
  padding-top: 250px;
  font-family: Arial, sans-serif;
}

/* TOPO FIXO */
.topo {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #222;
  color: #fff;
  padding: 10px;
  z-index: 1000;
}

.titulo {
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 8px;
}

/* INFO */
.topo-conteudo {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  font-size: 14px;
}

.box {
  background: #333;
  padding: 6px;
  border-radius: 6px;
  text-align: center;
}

.marcado {
  background: #4caf50;
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
}

/* PROGRESSO */
.progresso-container {
  margin-top: 10px;
}

.barra {
  width: 100%;
  height: 16px;
  background: #444;
  border-radius: 8px;
  overflow: hidden;
}

.barra-preenchida {
  height: 100%;
  background: #4caf50;
  transition: width 0.3s;
}

.percentual {
  text-align: center;
  font-size: 13px;
  margin-top: 4px;
}

/* BACKUP */
.backup-info {
  margin-top: 8px;
  text-align: center;
  font-size: 12px;
  color: #ccc;
}

.backup-info button {
  margin-top: 4px;
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  background: #4caf50;
  color: #fff;
  cursor: pointer;
}

/* TABELA */
table {
  width: 100%;
  border-collapse: collapse;
}

td {
  border: 1px solid #ddd;
  padding: 10px 0;
  text-align: center;
  cursor: pointer;
  user-select: none;
}

td.marcado {
  background: #4caf50;
  color: #fff;
  font-weight: bold;
}

/* DESKTOP */
@media (min-width: 768px) {
  body { padding-top: 180px; }
  .topo-conteudo { grid-template-columns: repeat(4, 1fr); }
}
</style>
</head>

<body>

<div class="topo">
  <div class="titulo">Projeto 50K</div>

  <div class="topo-conteudo">
    <div class="box">Saldo<br><span id="saldo" class="marcado">R$ 0,00</span></div>
    <div class="box">Faltam<br><span id="faltam">R$ 0,00</span></div>
    <div class="box">Depósitos<br><strong id="qtdMarcados">0</strong></div>
    <div class="box">Restam<br><strong id="qtdRestam">0</strong></div>
  </div>

  <div class="progresso-container">
    <div class="barra">
      <div class="barra-preenchida" id="barra"></div>
    </div>
    <div class="percentual" id="percentual">0% concluído</div>
  </div>

  <div class="backup-info">
    Último backup: <span id="backupData">—</span><br>
    <button onclick="restaurarUltimoBackup()">Restaurar último backup</button>
  </div>
</div>

<table id="tabela"></table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAzIGJub68rmKIt1Qzsc9Aygbd1IeHF4kY",
  authDomain: "tabela-selecao.firebaseapp.com",
  projectId: "tabela-selecao",
  storageBucket: "tabela-selecao.firebasestorage.app",
  messagingSenderId: "182647940029",
  appId: "1:182647940029:web:393aec06b26187c01828d4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = doc(db, "estado", "selecionados");

/* CONFIG */
const TOTAL = 316;
const SOMA_TOTAL = TOTAL * (TOTAL + 1) / 2;
const BACKUP_KEY = "projeto50k_backups";

let selecionados = new Set();

/* BACKUP VERSIONADO */
function salvarBackupVersionado() {
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "[]");

  backups.push({
    data: new Date().toISOString(),
    itens: [...selecionados]
  });

  if (backups.length > 20) backups.shift();

  localStorage.setItem(BACKUP_KEY, JSON.stringify(backups));
  atualizarInfoBackup();
}

function obterUltimoBackup() {
  const backups = JSON.parse(localStorage.getItem(BACKUP_KEY) || "[]");
  return backups.length ? backups[backups.length - 1] : null;
}

function restaurarUltimoBackup() {
  const ultimo = obterUltimoBackup();
  if (!ultimo) return alert("Nenhum backup disponível");

  selecionados = new Set(ultimo.itens);
  salvar();
  montarTabela();
}

window.restaurarUltimoBackup = restaurarUltimoBackup;

function atualizarInfoBackup() {
  const ultimo = obterUltimoBackup();
  document.getElementById("backupData").textContent =
    ultimo ? new Date(ultimo.data).toLocaleString("pt-BR") : "—";
}

/* LOAD */
async function carregar() {
  try {
    const snap = await getDoc(ref);
    if (snap.exists()) {
      selecionados = new Set(snap.data().itens || []);
    } else {
      const ultimo = obterUltimoBackup();
      if (ultimo) selecionados = new Set(ultimo.itens);
    }
  } catch {
    const ultimo = obterUltimoBackup();
    if (ultimo) selecionados = new Set(ultimo.itens);
  }

  montarTabela();
}

/* SAVE */
async function salvar() {
  await setDoc(ref, { itens: [...selecionados] });
  salvarBackupVersionado();
}

/* FORMAT */
function formatarBR(v) {
  return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

/* TABLE */
function montarTabela() {
  const tabela = document.getElementById("tabela");
  tabela.innerHTML = "";
  let linha;

  for (let i = 1; i <= TOTAL; i++) {
    if ((i - 1) % 10 === 0) linha = tabela.insertRow();
    const td = linha.insertCell();
    td.textContent = `R$ ${i}`;
    if (selecionados.has(i)) td.classList.add("marcado");

    td.onclick = () => {
      selecionados.has(i) ? selecionados.delete(i) : selecionados.add(i);
      td.classList.toggle("marcado");
      atualizar();
      salvar();
    };
  }
  atualizar();
}

/* UPDATE */
function atualizar() {
  const soma = [...selecionados].reduce((a, b) => a + b, 0);
  const qtd = selecionados.size;
  const perc = (qtd / TOTAL) * 100;

  document.getElementById("saldo").textContent = formatarBR(soma);
  document.getElementById("faltam").textContent = formatarBR(SOMA_TOTAL - soma);
  document.getElementById("qtdMarcados").textContent = qtd;
  document.getElementById("qtdRestam").textContent = TOTAL - qtd;

  document.getElementById("barra").style.width = perc + "%";
  document.getElementById("percentual").textContent = perc.toFixed(1) + "% concluído";

  atualizarInfoBackup();
}

carregar();
</script>

</body>
</html>
