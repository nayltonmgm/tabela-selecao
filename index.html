<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projeto 50K</title>

<style>
body {
  margin: 0;
  padding-top: 230px;
  font-family: Arial, sans-serif;
}

/* TOPO */
.topo {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #222;
  color: #fff;
  padding: 10px;
  z-index: 1000;
}

.topo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.titulo {
  font-size: 20px;
  font-weight: bold;
}

.btn-backups {
  background: #4caf50;
  border: none;
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
}

/* INFO */
.topo-conteudo {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  font-size: 14px;
  margin-top: 8px;
}

.box {
  background: #333;
  padding: 6px;
  border-radius: 6px;
  text-align: center;
}

.marcado {
  background: #4caf50;
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
}

/* PROGRESSO */
.barra {
  width: 100%;
  height: 16px;
  background: #444;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 10px;
}

.barra-preenchida {
  height: 100%;
  background: #4caf50;
  width: 0%;
}

.percentual {
  text-align: center;
  font-size: 13px;
  margin-top: 4px;
}

/* TABELA */
table {
  width: 100%;
  border-collapse: collapse;
}

td {
  border: 1px solid #ddd;
  padding: 10px 0;
  text-align: center;
  cursor: pointer;
  user-select: none;
}

td.marcado {
  background: #4caf50;
  color: #fff;
  font-weight: bold;
}

/* MODAL BACKUPS */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  z-index: 3000;
}

.modal-box {
  background: #fff;
  max-width: 420px;
  margin: 10% auto;
  padding: 16px;
  border-radius: 12px;
}

.backup-item {
  border-bottom: 1px solid #ddd;
  padding: 8px 0;
}

.backup-item button {
  margin-top: 6px;
}
</style>
</head>

<body>

<div class="topo">
  <div class="topo-header">
    <div class="titulo">Projeto 50K</div>
    <button class="btn-backups" onclick="abrirBackups()">ðŸ“¦ Backups</button>
  </div>

  <div class="topo-conteudo">
    <div class="box">Saldo<br><span id="saldo" class="marcado">R$ 0,00</span></div>
    <div class="box">Faltam<br><span id="faltam">R$ 0,00</span></div>
    <div class="box">DepÃ³sitos<br><strong id="qtdMarcados">0</strong></div>
    <div class="box">Restam<br><strong id="qtdRestam">0</strong></div>
  </div>

  <div class="barra">
    <div class="barra-preenchida" id="barra"></div>
  </div>
  <div class="percentual" id="percentual">0% concluÃ­do</div>
</div>

<table id="tabela"></table>

<!-- MODAL -->
<div class="modal" id="modalBackups">
  <div class="modal-box">
    <h3>ðŸ“¦ Backups</h3>
    <div id="listaBackups"></div>
    <button onclick="fecharBackups()">Fechar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzIGJub68rmKIt1Qzsc9Aygbd1IeHF4kY",
  authDomain: "tabela-selecao.firebaseapp.com",
  projectId: "tabela-selecao"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = doc(db, "estado", "selecionados");

const TOTAL = 316;
const SOMA_TOTAL = TOTAL * (TOTAL + 1) / 2;
const MAX_BACKUPS = 15;

let selecionados = new Set();

/* BACKUP */
function salvarBackup() {
  let backups = JSON.parse(localStorage.getItem("backups50k") || "[]");

  backups.push({
    data: new Date().toISOString(),
    itens: [...selecionados]
  });

  if (backups.length > MAX_BACKUPS) {
    backups = backups.slice(-MAX_BACKUPS);
  }

  localStorage.setItem("backups50k", JSON.stringify(backups));
}

/* MENU */
window.abrirBackups = () => {
  const lista = document.getElementById("listaBackups");
  lista.innerHTML = "";

  const backups = JSON.parse(localStorage.getItem("backups50k") || "[]").reverse();

  backups.forEach((b, i) => {
    const soma = b.itens.reduce((a, v) => a + v, 0);

    const div = document.createElement("div");
    div.className = "backup-item";
    div.innerHTML = `
      <strong>${new Date(b.data).toLocaleString("pt-BR")}</strong><br>
      DepÃ³sitos: ${b.itens.length}<br>
      Total: ${formatarBR(soma)}<br>
      <button onclick="restaurarBackup(${backups.length - 1 - i})">Restaurar</button>
    `;
    lista.appendChild(div);
  });

  document.getElementById("modalBackups").style.display = "block";
};

window.fecharBackups = () => {
  document.getElementById("modalBackups").style.display = "none";
};

window.restaurarBackup = (index) => {
  const backups = JSON.parse(localStorage.getItem("backups50k"));
  selecionados = new Set(backups[index].itens);
  salvar();
  montarTabela();
  fecharBackups();
};

/* FIREBASE */
async function carregar() {
  try {
    const snap = await getDoc(ref);
    if (snap.exists()) {
      selecionados = new Set(snap.data().itens || []);
    }
  } catch {
    const backups = JSON.parse(localStorage.getItem("backups50k") || "[]");
    if (backups.length) {
      selecionados = new Set(backups.at(-1).itens);
    }
  }
  montarTabela();
}

async function salvar() {
  await setDoc(ref, { itens: [...selecionados] });
  salvarBackup();
}

/* UTIL */
function formatarBR(v) {
  return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

/* TABELA */
function montarTabela() {
  const tabela = document.getElementById("tabela");
  tabela.innerHTML = "";
  let linha;

  for (let i = 1; i <= TOTAL; i++) {
    if ((i - 1) % 10 === 0) linha = tabela.insertRow();
    const td = linha.insertCell();
    td.textContent = `R$ ${i}`;

    if (selecionados.has(i)) td.classList.add("marcado");

    td.onclick = () => {
      selecionados.has(i) ? selecionados.delete(i) : selecionados.add(i);
      td.classList.toggle("marcado");
      atualizar();
      salvar();
    };
  }

  atualizar();
}

function atualizar() {
  const soma = [...selecionados].reduce((a,b)=>a+b,0);
  const qtd = selecionados.size;
  const pct = (qtd / TOTAL) * 100;

  saldo.textContent = formatarBR(soma);
  faltam.textContent = formatarBR(SOMA_TOTAL - soma);
  qtdMarcados.textContent = qtd;
  qtdRestam.textContent = TOTAL - qtd;
  barra.style.width = pct + "%";
  percentual.textContent = pct.toFixed(1) + "% concluÃ­do";
}

carregar();
</script>

</body>
</html>
