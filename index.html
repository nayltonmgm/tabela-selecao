<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Projeto 50K</title>

<style>
body {
  margin: 0;
  padding-top: 230px;
  font-family: Arial, sans-serif;
}

/* TOPO */
.topo {
  position: fixed;
  inset: 0 0 auto 0;
  background: #222;
  color: #fff;
  padding: 10px;
  z-index: 1000;
}

.topo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.titulo {
  font-size: 20px;
  font-weight: bold;
}

.btn-backups {
  background: #4caf50;
  border: none;
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
}

/* INFO */
.topo-conteudo {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  font-size: 14px;
  margin-top: 8px;
}

.box {
  background: #333;
  padding: 6px;
  border-radius: 6px;
  text-align: center;
}

.marcado {
  background: #4caf50;
  color: #fff;
  padding: 2px 6px;
  border-radius: 4px;
}

/* PROGRESSO */
.barra {
  width: 100%;
  height: 16px;
  background: #444;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 10px;
}

.barra-preenchida {
  height: 100%;
  background: #4caf50;
  width: 0%;
}

.percentual {
  text-align: center;
  font-size: 13px;
  margin-top: 4px;
}

/* TABELA */
table {
  width: 100%;
  border-collapse: collapse;
}

td {
  border: 1px solid #ddd;
  padding: 10px 0;
  text-align: center;
  cursor: pointer;
  user-select: none;
}

td.marcado {
  background: #4caf50;
  color: #fff;
  font-weight: bold;
}

/* MODAL */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  z-index: 3000;
}

.modal-box {
  background: #fff;
  max-width: 420px;
  margin: 10% auto;
  padding: 14px;
  border-radius: 12px;
  position: relative;
  max-height: 70vh;
  display: flex;
  flex-direction: column;
}

.btn-fechar {
  position: absolute;
  top: 8px;
  left: 8px;
  background: #eee;
  border: none;
  font-size: 16px;
  cursor: pointer;
  border-radius: 50%;
  width: 32px;
  height: 32px;
}

.lista-backups {
  margin-top: 30px;
  overflow-y: auto;
}

.backup-item {
  border-bottom: 1px solid #ddd;
  padding: 8px 0;
}

.atual {
  color: #4caf50;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="topo">
  <div class="topo-header">
    <div class="titulo">Projeto 50K</div>
    <button class="btn-backups" onclick="abrirBackups()">ðŸ“¦ Backups</button>
  </div>

  <div class="topo-conteudo">
    <div class="box">Saldo<br><span id="saldo" class="marcado">R$ 0,00</span></div>
    <div class="box">Faltam<br><span id="faltam">R$ 0,00</span></div>
    <div class="box">DepÃ³sitos<br><strong id="qtdMarcados">0</strong></div>
    <div class="box">Restam<br><strong id="qtdRestam">0</strong></div>
  </div>

  <div class="barra"><div class="barra-preenchida" id="barra"></div></div>
  <div class="percentual" id="percentual">0% concluÃ­do</div>
</div>

<table id="tabela"></table>

<!-- MODAL BACKUPS -->
<div class="modal" id="modalBackups">
  <div class="modal-box">
    <button class="btn-fechar" onclick="fecharBackups()">âœ–</button>
    <h3 style="text-align:center">ðŸ“¦ Backups</h3>
    <div class="lista-backups" id="listaBackups"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzIGJub68rmKIt1Qzsc9Aygbd1IeHF4kY",
  authDomain: "tabela-selecao.firebaseapp.com",
  projectId: "tabela-selecao"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = doc(db, "estado", "selecionados");

const TOTAL = 316;
const SOMA_TOTAL = TOTAL * (TOTAL + 1) / 2;
const MAX_BACKUPS = 15;

let selecionados = new Set();

/* UTIL */
function formatarBR(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function tempoRelativo(data){
  const diff = (Date.now() - new Date(data)) / 1000;
  if (diff < 60) return "agora mesmo";
  if (diff < 3600) return `hÃ¡ ${Math.floor(diff/60)} min`;
  if (diff < 86400) return `hÃ¡ ${Math.floor(diff/3600)} h`;
  return `hÃ¡ ${Math.floor(diff/86400)} dias`;
}

/* BACKUPS */
function salvarBackup(){
  let backups = JSON.parse(localStorage.getItem("backups50k")||"[]");
  backups.push({ data:new Date().toISOString(), itens:[...selecionados] });
  if (backups.length > MAX_BACKUPS) backups = backups.slice(-MAX_BACKUPS);
  localStorage.setItem("backups50k", JSON.stringify(backups));
}

window.abrirBackups = ()=>{
  const lista = document.getElementById("listaBackups");
  lista.innerHTML="";
  const backups = JSON.parse(localStorage.getItem("backups50k")||"[]").reverse();

  backups.forEach((b,i)=>{
    const soma = b.itens.reduce((a,v)=>a+v,0);
    const atual = JSON.stringify(b.itens) === JSON.stringify([...selecionados]);

    const div = document.createElement("div");
    div.className="backup-item";
    div.innerHTML = `
      <strong>${tempoRelativo(b.data)}</strong> ${atual ? '<span class="atual">(atual)</span>' : ''}<br>
      Total: ${formatarBR(soma)}<br>
      <button onclick="restaurarBackup(${backups.length-1-i})">Restaurar</button>
    `;
    lista.appendChild(div);
  });

  modalBackups.style.display="block";
};

window.fecharBackups = ()=> modalBackups.style.display="none";

window.restaurarBackup = (i)=>{
  if(!confirm("Deseja restaurar este backup?")) return;
  const backups = JSON.parse(localStorage.getItem("backups50k"));
  selecionados = new Set(backups[i].itens);
  salvar();
  montarTabela();
  fecharBackups();
};

/* FIREBASE */
async function carregar(){
  try{
    const snap = await getDoc(ref);
    if(snap.exists()) selecionados = new Set(snap.data().itens||[]);
  }catch{
    const b = JSON.parse(localStorage.getItem("backups50k")||"[]");
    if(b.length) selecionados = new Set(b.at(-1).itens);
  }
  montarTabela();
}

async function salvar(){
  await setDoc(ref,{itens:[...selecionados]});
  salvarBackup();
}

/* TABELA */
function montarTabela(){
  tabela.innerHTML="";
  let linha;
  for(let i=1;i<=TOTAL;i++){
    if((i-1)%10===0) linha=tabela.insertRow();
    const td=linha.insertCell();
    td.textContent=`R$ ${i}`;
    if(selecionados.has(i)) td.classList.add("marcado");
    td.onclick=()=>{
      selecionados.has(i)?selecionados.delete(i):selecionados.add(i);
      td.classList.toggle("marcado");
      atualizar(); salvar();
    };
  }
  atualizar();
}

function atualizar(){
  const soma=[...selecionados].reduce((a,b)=>a+b,0);
  const qtd=selecionados.size;
  const pct=(qtd/TOTAL)*100;

  saldo.textContent=formatarBR(soma);
  faltam.textContent=formatarBR(SOMA_TOTAL-soma);
  qtdMarcados.textContent=qtd;
  qtdRestam.textContent=TOTAL-qtd;
  barra.style.width=pct+"%";
  percentual.textContent=pct.toFixed(1)+"% concluÃ­do";
}

carregar();
</script>

</body>
</html>
